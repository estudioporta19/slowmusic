<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéµ Music Practice Tool</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a2e;
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
            box-sizing: border-box;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
        }

        .container {
            background-color: rgba(30, 40, 60, 0.9);
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
            padding: 30px;
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        h1, h2, h3 {
            color: #e0e0e0;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .input-group, .control-group {
            background-color: rgba(40, 50, 80, 0.7);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
        }

        .input-group label, .control-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #b0b0b0;
        }

        input[type="file"] {
            display: none;
        }

        .custom-file-upload {
            background: linear-gradient(45deg, #6a11cb, #2575fc);
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s ease;
            display: inline-block;
            text-align: center;
            width: fit-content;
            margin: 0 auto;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border: none;
        }

        .custom-file-upload:hover {
            background: linear-gradient(45deg, #2575fc, #6a11cb);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        #fileInfo {
            text-align: center;
            margin-top: 15px;
            font-style: italic;
            color: #a0a0a0;
        }

        #loadingStatus {
            text-align: center;
            margin-top: 15px;
            font-size: 1.1em;
            color: #f39c12;
            font-weight: bold;
            display: none;
        }

        .waveform-container {
            width: 100%;
            height: 150px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-top: 20px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #waveformCanvas {
            width: 100%;
            height: 100%;
            display: block;
            cursor: crosshair;
        }

        .playback-indicator, .loop-indicator {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #ffcc00;
            z-index: 10;
            pointer-events: none;
            display: none; /* Hidden by default */
        }

        .loop-indicator.start {
            background-color: #00ff00; /* Green for A */
        }

        .loop-indicator.end {
            background-color: #ff0000; /* Red for B */
        }

        .control-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .control-row label {
            margin-bottom: 0;
            flex-basis: 120px; /* Give labels a consistent width */
        }

        .control-row input[type="range"] {
            flex-grow: 1;
            width: auto; /* Override default width */
            margin: 0 10px;
            -webkit-appearance: none;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            outline: none;
            transition: opacity .2s;
        }

        .control-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #2575fc;
            cursor: pointer;
            transition: background 0.3s ease;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }

        .control-row input[type="range"]::-webkit-slider-thumb:hover {
            background: #6a11cb;
        }

        .control-row .value {
            min-width: 60px;
            text-align: right;
            font-weight: bold;
            color: #72efdd;
        }

        .reset-btn {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            margin-left: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .reset-btn:hover {
            background: linear-gradient(45deg, #e67e22, #f39c12);
            transform: translateY(-1px);
        }

        .playback-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .play-btn {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .play-btn:hover {
            background: linear-gradient(45deg, #0056b3, #007bff);
            transform: translateY(-2px);
        }

        .play-btn.playing {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .play-btn.playing:hover {
            background: linear-gradient(45deg, #c0392b, #e74c3c);
        }

        #loopListContainer {
            max-height: 200px;
            overflow-y: auto;
            padding-right: 10px; /* For scrollbar space */
        }

        #loopListContainer::-webkit-scrollbar {
            width: 8px;
        }

        #loopListContainer::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        #loopListContainer::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }

        #loopListContainer::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .loop-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.08);
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .loop-item span {
            color: #f0f0f0;
        }

        .loop-item .actions button {
            margin-left: 8px;
        }

        .loop-item .loop-name {
            font-weight: bold;
            flex-grow: 1;
            margin-right: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .loop-item .loop-times {
            font-size: 0.85em;
            color: #bbb;
            margin-right: 15px;
            min-width: 150px;
            text-align: right;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ Music Practice Tool</h1>

        <div class="input-group">
            <label for="audioFile">Carregar Ficheiro de √Åudio:</label>
            <input type="file" id="audioFile" accept="audio/*">
            <label for="audioFile" class="custom-file-upload">Selecionar Ficheiro de √Åudio</label>
            <div id="fileInfo" style="display: none;">
                <p id="fileName">Ficheiro: Nenhum</p>
                <p>Dura√ß√£o: <span id="duration">00:00</span></p>
            </div>
            <p id="loadingStatus" style="display: none;">A carregar...</p>
        </div>

        <div class="waveform-container" id="waveformContainer">
            <canvas id="waveformCanvas"></canvas>
            <div class="playback-indicator" id="playbackIndicator"></div>
            <div class="loop-indicator start" id="loopIndicatorA"></div>
            <div class="loop-indicator end" id="loopIndicatorB"></div>
        </div>

        <div class="controls" style="display: none;" id="controls">
            <div class="control-group">
                <h3>üéöÔ∏è Controlo de Velocidade e Tom</h3>
                <div class="control-row">
                    <label for="tempoSlider">Velocidade:</label>
                    <input type="range" id="tempoSlider" min="0.5" max="2.0" value="1.0" step="0.01">
                    <span class="value" id="tempoValue">1.00x</span>
                    <button class="reset-btn" id="tempoResetBtn">Reset</button>
                </div>
                <div class="control-row">
                    <label for="pitchSlider">Tom (Semitons):</label>
                    <input type="range" id="pitchSlider" min="-12" max="12" value="0" step="0.01">
                    <span class="value" id="pitchValue">0.00</span>
                    <button class="reset-btn" id="pitchResetBtn">Reset</button>
                </div>
            </div>

            <div class="control-group">
                <h3>üîÑ Controlo de Loop</h3>
                <div class="control-row">
                    <label>In√≠cio (A):</label>
                    <span class="value" id="loopAValue">00:00</span>
                    <button class="reset-btn" id="setLoopABtn">Definir A</button>
                </div>
                <div class="control-row">
                    <label>Fim (B):</label>
                    <span class="value" id="loopBValue">00:00</span>
                    <button class="reset-btn" id="setLoopBBtn">Definir B</button>
                </div>
                <div class="control-row" style="justify-content: center;">
                    <button class="play-btn" id="toggleLoopBtn" style="background: linear-gradient(45deg, #e74c3c, #c0392b);">Loop OFF ‚ùå</button>
                </div>
                <div class="control-row" style="justify-content: center; margin-top: 10px;">
                    <button class="reset-btn" id="resetLoopBtn" style="background: linear-gradient(45deg, #6c757d, #495057);">Resetar Loop</button>
                </div>
            </div>

            <div class="control-group">
                <h3>üíæ Loops Guardados</h3>
                <div class="control-row" style="justify-content: center; margin-bottom: 20px;">
                    <button id="saveLoopBtn" class="play-btn" style="background: linear-gradient(45deg, #007bff, #0056b3);">üíæ Guardar Loop Atual</button>
                </div>
                <div id="loopListContainer" style="max-height: 200px; overflow-y: auto; padding-right: 10px;">
                    <p id="noLoopsMessage" style="text-align: center; color: rgba(255, 255, 255, 0.7);">Nenhum loop guardado ainda.</p>
                </div>
            </div>

            <div class="playback-controls">
                <button class="play-btn" id="playPauseBtn">‚ñ∂Ô∏è Tocar</button>
                <button class="play-btn" id="stopBtn">‚èπÔ∏è Parar</button>
            </div>
        </div>
    </div>

    <script>
        // --- Vari√°veis Globais ---
        let audioContext = null;    
        let sourceNode;
        let soundtouchWorkletNode; 
        let audioBuffer;

        let isPlaying = false;
        let seekPosition = 0;    
        let playbackStartTime = 0;    

        let loopA = 0; 
        let loopB = 0; 
        let loopEnabled = false;

        let animationFrameId; 

        // --- Elementos do DOM ---
        const audioFile = document.getElementById('audioFile');
        const fileNameEl = document.getElementById('fileName');
        const durationEl = document.getElementById('duration');
        const fileInfoEl = document.getElementById('fileInfo');
        const loadingStatusEl = document.getElementById('loadingStatus');
        const controlsEl = document.getElementById('controls');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const stopBtn = document.getElementById('stopBtn');
        const tempoSlider = document.getElementById('tempoSlider');
        const tempoValueEl = document.getElementById('tempoValue');
        const tempoResetBtn = document.getElementById('tempoResetBtn');
        const pitchSlider = document.getElementById('pitchSlider');
        const pitchValueEl = document.getElementById('pitchValue');
        const pitchResetBtn = document.getElementById('pitchResetBtn');
        const loopAValueEl = document.getElementById('loopAValue');
        const loopBValueEl = document.getElementById('loopBValue');
        const setLoopABtn = document.getElementById('setLoopABtn');
        const setLoopBBtn = document.getElementById('setLoopBBtn');
        const toggleLoopBtn = document.getElementById('toggleLoopBtn');
        const resetLoopBtn = document.getElementById('resetLoopBtn'); 
        const waveformCanvas = document.getElementById('waveformCanvas');
        const waveformContainer = document.getElementById('waveformContainer');
        const playbackIndicator = document.getElementById('playbackIndicator');
        const loopIndicatorA = document.getElementById('loopIndicatorA');
        const loopIndicatorB = document.getElementById('loopIndicatorB');

        const saveLoopBtn = document.getElementById('saveLoopBtn');
        const loopListContainer = document.getElementById('loopListContainer');
        const noLoopsMessage = document.getElementById('noLoopsMessage');

        // --- Nova Estrutura de Dados para Loops ---
        let savedLoops = {}; 
        const LOCAL_STORAGE_KEY = 'soundtouch_saved_loops';

        // --- Fun√ß√µes Auxiliares ---

        function formatTime(seconds) {
            if (isNaN(seconds) || seconds < 0) return "00:00";
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        function saveLoopsToLocalStorage() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(savedLoops));
                console.log('Loops guardados no localStorage.');
            } catch (e) {
                console.error('Erro ao guardar loops no localStorage:', e);
                alert('N√£o foi poss√≠vel guardar os loops. O armazenamento pode estar cheio ou bloqueado.');
            }
        }

        function loadLoopsFromLocalStorage() {
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (data) {
                    savedLoops = JSON.parse(data);
                    console.log('Loops carregados do localStorage.');
                }
            } catch (e) {
                console.error('Erro ao carregar loops do localStorage:', e);
                savedLoops = {}; 
            }
        }

        function renderLoopList() {
            loopListContainer.innerHTML = ''; 

            if (!audioBuffer) {
                noLoopsMessage.textContent = 'Carregue um √°udio para ver os loops.';
                loopListContainer.appendChild(noLoopsMessage);
                return;
            }

            const currentFileName = fileNameEl.textContent.replace('Ficheiro: ', '');
            const loopsForCurrentFile = savedLoops[currentFileName] || [];

            if (loopsForCurrentFile.length === 0) {
                noLoopsMessage.textContent = 'Nenhum loop guardado para este √°udio ainda.';
                loopListContainer.appendChild(noLoopsMessage);
                return;
            }

            loopsForCurrentFile.forEach(loop => {
                const loopItem = document.createElement('div');
                loopItem.className = 'loop-item'; 
                
                const loopName = document.createElement('span');
                loopName.className = 'loop-name';
                loopName.textContent = loop.name;

                const loopTimes = document.createElement('span');
                loopTimes.className = 'loop-times';
                loopTimes.textContent = `[${formatTime(loop.loopA)} - ${formatTime(loop.loopB)}]`;

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'actions';

                const loadBtn = document.createElement('button');
                loadBtn.textContent = 'Carregar';
                loadBtn.className = 'reset-btn'; 
                loadBtn.style.background = 'linear-gradient(45deg, #1abc9c, #16a085)';
                loadBtn.onclick = () => loadLoop(loop.id, currentFileName);

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Apagar';
                deleteBtn.className = 'reset-btn'; 
                deleteBtn.style.background = 'linear-gradient(45deg, #FF6B6B, #d9534f)';
                deleteBtn.onclick = () => deleteLoop(loop.id, currentFileName);

                actionsDiv.appendChild(loadBtn);
                actionsDiv.appendChild(deleteBtn);

                loopItem.appendChild(loopName);
                loopItem.appendChild(loopTimes);
                loopItem.appendChild(actionsDiv);
                loopListContainer.appendChild(loopItem);
            });
        }

        // --- Fun√ß√µes de Gest√£o de Loops ---

        function saveCurrentLoop() {
            if (!audioBuffer) {
                alert('Carregue um ficheiro de √°udio antes de guardar um loop.');
                return;
            }

            const loopName = prompt('Qual o nome para este loop?');
            if (!loopName || loopName.trim() === '') {
                alert('O nome do loop n√£o pode estar vazio.');
                return;
            }

            const currentFileName = fileNameEl.textContent.replace('Ficheiro: ', '');
            if (!savedLoops[currentFileName]) {
                savedLoops[currentFileName] = [];
            }

            const newLoop = {
                id: generateUniqueId(),
                name: loopName.trim(),
                loopA: loopA,
                loopB: loopB
            };

            savedLoops[currentFileName].push(newLoop);
            saveLoopsToLocalStorage();
            renderLoopList();
            alert(`Loop "${newLoop.name}" guardado com sucesso!`);
        }

        function loadLoop(id, fileName) {
            if (!audioBuffer || fileNameEl.textContent.replace('Ficheiro: ', '') !== fileName) {
                alert('Por favor, carregue o ficheiro de √°udio correto antes de carregar este loop.');
                return;
            }

            const loopsForFile = savedLoops[fileName];
            const loopToLoad = loopsForFile ? loopsForFile.find(loop => loop.id === id) : null;

            if (loopToLoad) {
                stopPlayback(); 
                
                loopA = loopToLoad.loopA;
                loopB = loopToLoad.loopB;
                loopAValueEl.textContent = formatTime(loopA);
                loopBValueEl.textContent = formatTime(loopB);
                
                loopEnabled = true; 
                toggleLoopBtn.textContent = 'Loop ON ‚úÖ';
                toggleLoopBtn.style.background = 'linear-gradient(45deg, #1abc9c, #16a085)';
                
                updateLoopIndicators(); 
                alert(`Loop "${loopToLoad.name}" carregado. Loop ativado.`);
            } else {
                alert('Loop n√£o encontrado.');
            }
        }

        function deleteLoop(id, fileName) {
            if (!confirm('Tem a certeza que quer apagar este loop?')) {
                return;
            }

            if (savedLoops[fileName]) {
                savedLoops[fileName] = savedLoops[fileName].filter(loop => loop.id !== id);
                if (savedLoops[fileName].length === 0) {
                    delete savedLoops[fileName];
                }
                saveLoopsToLocalStorage();
                renderLoopList();
                alert('Loop apagado.');
            }
        }


        // --- Fun√ß√µes de Reprodu√ß√£o ---

        async function startPlayback() {
            if (!audioBuffer) {
                alert('Por favor, carregue um ficheiro de √°udio primeiro.');
                return;
            }

            // Garante que o AudioContext est√° em estado 'running' (essencial para pol√≠ticas de autoplay)
            if (audioContext.state === 'suspended') {
                try {
                    await audioContext.resume();
                    console.log('AudioContext resumed successfully.');
                } catch (e) {
                    console.error('Erro ao resumir AudioContext:', e);
                    alert('N√£o foi poss√≠vel iniciar a reprodu√ß√£o. Por favor, tente novamente ou verifique as permiss√µes de √°udio do navegador.');
                    return;
                }
            }
            
            // L√≥gica de reprodu√ß√£o real
            _actualStartPlayback();
        }

        function _actualStartPlayback() {
            if (isPlaying) {
                stopPlayback(); 
            }

            sourceNode = audioContext.createBufferSource();
            sourceNode.buffer = audioBuffer;

            // Recria o AudioWorkletNode para garantir um estado limpo
            if (soundtouchWorkletNode) { 
                soundtouchWorkletNode.disconnect();
                soundtouchWorkletNode = null; 
            }
            soundtouchWorkletNode = new AudioWorkletNode(audioContext, 'scheduled-soundtouch-worklet');

            sourceNode.connect(soundtouchWorkletNode);
            soundtouchWorkletNode.connect(audioContext.destination);

            soundtouchWorkletNode.port.postMessage({ type: 'setDuration', duration: audioBuffer.duration });

            soundtouchWorkletNode.parameters.get('tempo').value = parseFloat(tempoSlider.value);
            soundtouchWorkletNode.parameters.get('pitchSemitones').value = parseFloat(pitchSlider.value);
            
            soundtouchWorkletNode.port.postMessage({
                type: 'setLoopPoints',
                loopA: loopA,
                loopB: loopB,
                loopEnabled: loopEnabled
            });

            soundtouchWorkletNode.port.onmessage = (event) => {
                if (event.data.type === 'playbackEnded') {
                    if (!loopEnabled) { 
                        stopPlayback();
                    }
                }
            };

            playbackStartTime = audioContext.currentTime - seekPosition;
            sourceNode.start(0, seekPosition); 
            isPlaying = true;
            playPauseBtn.textContent = '‚è∏Ô∏è Pausar';
            playPauseBtn.classList.add('playing');
            playbackIndicator.style.display = 'block';
            updatePlaybackIndicator(); 
        }


        function stopPlayback() {
            if (isPlaying) {
                if (sourceNode) {
                    try {
                        sourceNode.stop();
                        sourceNode.disconnect();
                    } catch (e) {
                        console.warn("Erro ao parar sourceNode (pode j√° ter parado):", e);
                    }
                }
                if (soundtouchWorkletNode) {
                    soundtouchWorkletNode.disconnect();
                    soundtouchWorkletNode = null; 
                }

                isPlaying = false;
                seekPosition = 0; 
                playPauseBtn.textContent = '‚ñ∂Ô∏è Tocar';
                playPauseBtn.classList.remove('playing');
                playbackIndicator.style.display = 'none';
                cancelAnimationFrame(animationFrameId); 
                updatePlaybackIndicator(); 
            }
        }

        function pausePlayback() {
            if (isPlaying) {
                seekPosition = audioContext.currentTime - playbackStartTime;
                if (sourceNode) {
                    try {
                        sourceNode.stop();
                        sourceNode.disconnect();
                    } catch (e) {
                        console.warn("Erro ao parar sourceNode (pode j√° ter parado durante a pausa):", e);
                    }
                }
                if (soundtouchWorkletNode) {
                    soundtouchWorkletNode.disconnect();
                    soundtouchWorkletNode = null; 
                }
                isPlaying = false;
                playPauseBtn.textContent = '‚ñ∂Ô∏è Tocar';
                playPauseBtn.classList.remove('playing');
                cancelAnimationFrame(animationFrameId); 
            }
        }

        function togglePlayPause() {
            if (isPlaying) {
                pausePlayback();
            } else {
                startPlayback();
            }
        }

        function resetControls() {
            tempoSlider.value = 1.0;
            tempoValueEl.textContent = '1.00x';
            if (soundtouchWorkletNode) {
                soundtouchWorkletNode.parameters.get('tempo').value = 1.0;
            }

            pitchSlider.value = 0;
            pitchValueEl.textContent = '0.00';
            if (soundtouchWorkletNode) {
                soundtouchWorkletNode.parameters.get('pitchSemitones').value = 0;
            }

            loopEnabled = false;
            toggleLoopBtn.textContent = 'Loop OFF ‚ùå';
            toggleLoopBtn.style.background = 'linear-gradient(45deg, #e74c3c, #c0392b)';
            if (soundtouchWorkletNode) {
                soundtouchWorkletNode.port.postMessage({ type: 'setLoopPoints', loopEnabled: loopEnabled });
            }

            stopPlayback(); 
        }
        
        function resetLoopPoints() {
            if (!audioBuffer) {
                alert('Carregue um √°udio primeiro para resetar o loop.');
                return;
            }
            stopPlayback(); 
            loopA = 0;
            loopB = audioBuffer.duration;
            loopAValueEl.textContent = formatTime(loopA);
            loopBValueEl.textContent = formatTime(loopB);
            updateLoopIndicators(); 
            loopEnabled = false; 
            toggleLoopBtn.textContent = 'Loop OFF ‚ùå';
            toggleLoopBtn.style.background = 'linear-gradient(45deg, #e74c3c, #c0392b)';
            if (soundtouchWorkletNode) {
                soundtouchWorkletNode.port.postMessage({ type: 'setLoopPoints', loopA: loopA, loopB: loopB, loopEnabled: loopEnabled });
            }
            alert('Pontos de loop resetados para a faixa completa.');
        }

        // --- Fun√ß√µes de Renderiza√ß√£o e Eventos da Waveform ---

        function drawWaveform(buffer) {
            const canvas = waveformCanvas;
            const ctx = canvas.getContext('2d');
            const width = canvas.width = waveformContainer.clientWidth;
            const height = canvas.height = waveformContainer.clientHeight;

            ctx.clearRect(0, 0, width, height); 
            ctx.fillStyle = 'rgba(255, 255, 255, 0.1)'; 
            ctx.fillRect(0, 0, width, height);

            const data = buffer.getChannelData(0); 
            const step = Math.ceil(data.length / width);
            const amp = height / 2;

            ctx.strokeStyle = '#72efdd'; 
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            ctx.moveTo(0, amp);

            for (let i = 0; i < width; i++) {
                let min = 1.0;
                let max = -1.0;
                for (let j = 0; j < step; j++) {
                    const datum = data[(i * step) + j];
                    if (datum < min) min = datum;
                    if (datum > max) max = datum;
                }
                ctx.lineTo(i, (1 + min * 0.8) * amp); 
                ctx.lineTo(i, (1 + max * 0.8) * amp); 
            }
            ctx.lineTo(width, amp);
            ctx.stroke();
        }

        function updatePlaybackIndicator() {
            if (!audioBuffer) return;

            let currentPlaybackTime = seekPosition;
            if (isPlaying) {
                currentPlaybackTime = audioContext.currentTime - playbackStartTime;
                if (currentPlaybackTime < 0) currentPlaybackTime = 0;
                if (currentPlaybackTime > audioBuffer.duration) currentPlaybackTime = audioBuffer.duration;
            }
            
            const duration = audioBuffer.duration;
            const positionRatio = currentPlaybackTime / duration;
            const xPosition = positionRatio * waveformCanvas.width;

            playbackIndicator.style.left = `${xPosition}px`;
            playbackIndicator.style.display = 'block'; 

            if (isPlaying) {
                animationFrameId = requestAnimationFrame(updatePlaybackIndicator);
            }
        }

        function updateLoopIndicators() {
            if (!audioBuffer) {
                loopIndicatorA.style.display = 'none';
                loopIndicatorB.style.display = 'none';
                return;
            }

            const duration = audioBuffer.duration;
            const width = waveformCanvas.width;

            const effectiveLoopA = Math.max(0, Math.min(loopA, duration));
            const effectiveLoopB = Math.max(0, Math.min(loopB, duration));

            const posA = (effectiveLoopA / duration) * width;
            const posB = (effectiveLoopB / duration) * width;

            loopIndicatorA.style.left = `${posA}px`;
            loopIndicatorB.style.left = `${posB}px`;

            loopIndicatorA.style.display = 'block';
            loopIndicatorB.style.display = 'block';
        }

        // --- Event Listeners ---

        audioFile.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                loadAudioFile(file);
            }
        });

        playPauseBtn.addEventListener('click', togglePlayPause);
        stopBtn.addEventListener('click', stopPlayback);

        tempoSlider.addEventListener('input', () => {
            const tempo = parseFloat(tempoSlider.value);
            tempoValueEl.textContent = `${tempo.toFixed(2)}x`;
            if (soundtouchWorkletNode) {
                soundtouchWorkletNode.parameters.get('tempo').value = tempo;
            }
        });

        tempoResetBtn.addEventListener('click', () => {
            tempoSlider.value = 1.0;
            tempoValueEl.textContent = '1.00x';
            if (soundtouchWorkletNode) {
                soundtouchWorkletNode.parameters.get('tempo').value = 1.0;
            }
        });

        pitchSlider.addEventListener('input', () => {
            const pitch = parseFloat(pitchSlider.value);
            pitchValueEl.textContent = `${pitch.toFixed(2)}`;
            if (soundtouchWorkletNode) {
                soundtouchWorkletNode.parameters.get('pitchSemitones').value = pitch;
            }
        });

        pitchResetBtn.addEventListener('click', () => {
            pitchSlider.value = 0;
            pitchValueEl.textContent = '0.00';
            if (soundtouchWorkletNode) {
                soundtouchWorkletNode.parameters.get('pitchSemitones').value = 0;
            }
        });

        setLoopABtn.addEventListener('click', () => {
            if (!audioBuffer) return;
            let currentPlaybackTime = 0;
            if (isPlaying) {
                currentPlaybackTime = audioContext.currentTime - playbackStartTime;
            } else {
                currentPlaybackTime = seekPosition; 
            }
            loopA = Math.max(0, currentPlaybackTime);
            if (loopA > loopB) loopB = loopA; 
            loopAValueEl.textContent = formatTime(loopA);
            loopBValueEl.textContent = formatTime(loopB); 
            updateLoopIndicators();
            if (soundtouchWorkletNode) {
                soundtouchWorkletNode.port.postMessage({ type: 'setLoopPoints', loopA: loopA, loopB: loopB });
            }
        });

        setLoopBBtn.addEventListener('click', () => {
            if (!audioBuffer) return;
            let currentPlaybackTime = 0;
            if (isPlaying) {
                currentPlaybackTime = audioContext.currentTime - playbackStartTime;
            } else {
                currentPlaybackTime = seekPosition;
            }
            loopB = Math.max(0, currentPlaybackTime);
            if (loopB < loopA) loopA = loopB; 
            loopAValueEl.textContent = formatTime(loopA); 
            loopBValueEl.textContent = formatTime(loopB);
            updateLoopIndicators();
            if (soundtouchWorkletNode) {
                soundtouchWorkletNode.port.postMessage({ type: 'setLoopPoints', loopA: loopA, loopB: loopB });
            }
        });

        toggleLoopBtn.addEventListener('click', () => {
            if (!audioBuffer) return;
            loopEnabled = !loopEnabled;
            toggleLoopBtn.textContent = loopEnabled ? 'Loop ON ‚úÖ' : 'Loop OFF ‚ùå';
            toggleLoopBtn.style.background = loopEnabled ? 'linear-gradient(45deg, #1abc9c, #16a085)' : 'linear-gradient(45deg, #e74c3c, #c0392b)';
            if (soundtouchWorkletNode) {
                soundtouchWorkletNode.port.postMessage({ type: 'setLoopPoints', loopEnabled: loopEnabled });
            }
        });

        resetLoopBtn.addEventListener('click', resetLoopPoints);


        waveformCanvas.addEventListener('click', (event) => {
            if (!audioBuffer) return;

            const rect = waveformCanvas.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const clickTime = (clickX / waveformCanvas.width) * audioBuffer.duration;

            if (event.shiftKey) {
                loopB = clickTime;
                if (loopB < loopA) loopA = loopB; 
                loopBValueEl.textContent = formatTime(loopB);
                loopAValueEl.textContent = formatTime(loopA); 
            } else {
                loopA = clickTime;
                if (loopA > loopB) loopB = loopA; 
                loopAValueEl.textContent = formatTime(loopA);
                loopBValueEl.textContent = formatTime(loopB); 
            }
            updateLoopIndicators();
            if (soundtouchWorkletNode) {
                soundtouchWorkletNode.port.postMessage({ type: 'setLoopPoints', loopA: loopA, loopB: loopB });
            }
        });

        saveLoopBtn.addEventListener('click', saveCurrentLoop);

        async function loadAudioFile(file) {
            fileNameEl.textContent = `Ficheiro: ${file.name}`;
            durationEl.textContent = '00:00'; 
            fileInfoEl.style.display = 'block';
            loadingStatusEl.textContent = 'A carregar e descodificar...';
            loadingStatusEl.style.display = 'block'; 
            controlsEl.style.display = 'none'; 

            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                try {
                    await audioContext.audioWorklet.addModule('./soundtouch-worklet.js');
                    console.log('AudioWorklet "scheduled-soundtouch-worklet" carregado com sucesso.');
                } catch (error) {
                    console.error('Erro ao carregar AudioWorklet:', error);
                    loadingStatusEl.textContent = 'Erro fatal: N√£o foi poss√≠vel carregar o processador de √°udio! Verifique o console.';
                    return; 
                }
            }
            // Tenta resumir o AudioContext logo ap√≥s a intera√ß√£o de carregar ficheiro
            if (audioContext.state === 'suspended') {
                try {
                    await audioContext.resume();
                    console.log('AudioContext resumed after file load.');
                } catch (e) {
                    console.error('Erro ao resumir AudioContext ap√≥s carregar ficheiro:', e);
                }
            }
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                audioContext.decodeAudioData(e.target.result)
                    .then(buffer => {
                        audioBuffer = buffer;
                        durationEl.textContent = formatTime(audioBuffer.duration);
                        drawWaveform(audioBuffer);
                        
                        loopA = 0; 
                        loopB = audioBuffer.duration;
                        updateLoopIndicators(); 
                        loopAValueEl.textContent = formatTime(loopA);
                        loopBValueEl.textContent = formatTime(loopB);

                        loadingStatusEl.textContent = 'Pronto a tocar!';
                        setTimeout(() => { loadingStatusEl.style.display = 'none'; }, 2000); 
                        controlsEl.style.display = 'block'; 
                        resetControls(); 
                        
                        renderLoopList(); 
                    })
                    .catch(error => {
                        console.error('Erro ao descodificar √°udio:', error);
                        loadingStatusEl.textContent = 'Erro ao carregar o ficheiro! Verifique o console para mais detalhes.';
                    });
            };
            reader.readAsArrayBuffer(file); 
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadLoopsFromLocalStorage();
            renderLoopList(); 
        });

        window.addEventListener('resize', () => {
            if (audioBuffer) {
                drawWaveform(audioBuffer);
                updatePlaybackIndicator();
                updateLoopIndicators();
            }
        });
    </script>
</body>
</html>
